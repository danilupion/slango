name: ðŸ”„ Sync Renovate Changesets

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - '**/package.json'
      - 'pnpm-lock.yaml'

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: renovate-changeset-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  changeset:
    # Only run for Renovate bot PRs
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10.28.1

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24.13.0
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Check if changeset already exists
        id: check
        run: |
          if pnpm release:check 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect affected packages and create changeset
        if: steps.check.outputs.exists == 'false'
        run: |
          # Find which packages have changes compared to main
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          # Extract unique package paths (configs/* and packages/*)
          PACKAGE_PATHS=$(echo "$CHANGED_FILES" | grep -E '^(configs|packages)/' | cut -d'/' -f1-2 | sort -u || true)

          if [ -z "$PACKAGE_PATHS" ]; then
            echo "No package changes detected, creating empty changeset"
            pnpm changeset add --empty
          else
            # Generate unique changeset filename
            CHANGESET_FILE=".changeset/renovate-$(date +%s).md"

            # Start building the changeset content
            echo "---" > "$CHANGESET_FILE"

            for pkg_path in $PACKAGE_PATHS; do
              # Get package name from package.json if it exists
              if [ -f "$pkg_path/package.json" ]; then
                PKG_NAME=$(node -p "require('./$pkg_path/package.json').name")
                echo "\"$PKG_NAME\": patch" >> "$CHANGESET_FILE"
                echo "Adding package: $PKG_NAME"
              fi
            done

            echo "---" >> "$CHANGESET_FILE"
            echo "" >> "$CHANGESET_FILE"
            echo "Dependencies bump" >> "$CHANGESET_FILE"

            echo "Created changeset:"
            cat "$CHANGESET_FILE"
          fi

      - name: Amend Renovate commit with changeset
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .changeset/
          git commit --amend --no-edit
          git push --force-with-lease
